<!doctype html>
<html>
<head>
  <title>Robot Supervisor Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 20px; }
    .status-alive { color: green; font-weight: bold; }
    .status-disconnected { color: red; font-weight: bold; }
    .ack-output { color: blue; font-family: monospace; white-space: pre-wrap; }
  </style>
</head>
<body>

<div class="container">
  <h2>Robot Supervisor Dashboard</h2>

  <div class="row mb-3">
    <div class="col-md-4">
      <select id="robotSelect" class="form-select"></select>
    </div>
    <div class="col-md-4">
      <input id="commandInput" class="form-control" placeholder="Enter Command (move, scan, stop or bash)">
    </div>
    <div class="col-md-4">
      <button class="btn btn-primary w-100" onclick="sendCommand()">Send Command</button>
    </div>
  </div>

  <table class="table table-striped table-hover">
    <thead>
      <tr>
        <th>Robot ID</th>
        <th>Status</th>
        <th>Last Task</th>
        <th>Last Task Output</th>
        <th>Last Seen</th>
        <th>Battery</th>
        <th>CPU</th>
        <th>Memory</th>
        <th>Uptime</th>
      </tr>
    </thead>
    <tbody id="robotTable"></tbody>
  </table>
</div>

<script>
  const ws = new WebSocket("ws://127.0.0.1:8000/ws");
  const robotDropdown = document.getElementById("robotSelect");
  const robotTable = document.getElementById("robotTable");

  ws.onmessage = event => {
    const robots = JSON.parse(event.data);

    const selectedRobot = robotDropdown.value;

    // Rebuild dropdown
    robotDropdown.innerHTML = "";
    for (const rid of Object.keys(robots)) {
      const option = document.createElement("option");
      option.value = rid;
      option.text = rid;
      robotDropdown.add(option);
    }

    // Restore previous selection if still exists
    if (selectedRobot && robots[selectedRobot]) {
      robotDropdown.value = selectedRobot;
    }

    // Rebuild table
    robotTable.innerHTML = "";
    for (const [rid, state] of Object.entries(robots)) {
      const row = `
        <tr>
          <td>${rid}</td>
          <td class="${state.status === "alive" ? "status-alive" : "status-disconnected"}">${state.status}</td>
          <td>${state.last_task || "idle"}</td>
          <td class="ack-output">${state.last_task_output || ""}</td>
          <td>${new Date(state.last_seen * 1000).toLocaleTimeString()}</td>
          <td>${state.battery_percent}</td>
          <td>${state.cpu_percent}</td>
          <td>${state.memory_percent}</td>
          <td>${state.uptime_sec}</td>
        </tr>`;
      robotTable.insertAdjacentHTML("beforeend", row);
    }
  };

  function sendCommand() {
    const target = robotDropdown.value;
    const cmd = document.getElementById("commandInput").value;

    if (!target) {
      alert("Please select a robot first!");
      return;
    }
    if (!cmd) {
      alert("Please enter a command!");
      return;
    }

    // Detect bash commands (optional: you can prefix with "bash:")
    let type = "command";
    if (cmd.startsWith("bash:")) {
      type = "bash";
      cmd_to_send = cmd.replace(/^bash:/, "").trim();
    } else {
      cmd_to_send = cmd;
    }

    ws.send(JSON.stringify({ target, cmd: cmd_to_send, type }));
    document.getElementById("commandInput").value = "";
  }
</script>

</body>
</html>
